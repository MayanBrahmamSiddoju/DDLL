<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Matterport Showcase</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
</head>
<body>
  <h1>Welcome to the Showcase</h1>

  <!-- The Matterport Showcase iframe -->
  <iframe
    id="showcase"
    width="740"
    height="480"
    src="/bundle/showcase.html?m=zQV33R4HsGA&applicationKey=h8m1gx75u1bezk7yaw7yggzwb"
    frameborder="0"
    allowfullscreen
    allow="vr">
  </iframe>

  <button id="customCameraButton" onclick="enableCustomCamera()" disabled>
    Enable Custom Camera
  </button>

  <script>
    // Select the iframe element
    const showcase = document.getElementById('showcase');
    const customCameraButton = document.getElementById('customCameraButton');

    let mpSdk = null;

    // Connect to the Matterport SDK after the iframe loads
    showcase.addEventListener('load', async function () {
      try {
        const showcaseWindow = showcase.contentWindow;

        // Wait for the SDK to connect
        mpSdk = await showcaseWindow.MP_SDK.connect(showcaseWindow);
        console.log('Connected to MP_SDK:', mpSdk);

        // Enable the custom camera button
        customCameraButton.disabled = false;
      } catch (e) {
        console.error('Error connecting to MP_SDK:', e);
      }
    });

    // Function to enable the custom camera
    async function enableCustomCamera() {
      try {
        if (!mpSdk) {
          console.error('SDK is not connected.');
          return;
        }

        console.log('Enabling custom camera...');

        // Create a three.js camera object
        const myCamera = new THREE.PerspectiveCamera(45, 4 / 3, 1, 1000);
        myCamera.position.set(0, 2, 5); // Initial position of the camera

        console.log('Created custom THREE.PerspectiveCamera:', myCamera);

        // Create a scene object and a node with a camera component
        const [sceneObject] = await mpSdk.Scene.createObjects(1);
        const node = sceneObject.addNode();
        const cameraComponent = node.addComponent('mp.camera', {
          enabled: true,
          camera: myCamera,
        });

        console.log('Added camera component to node:', cameraComponent);

        // Spy on the ONACCESSGRANTED event
        class AccessGrantedSpy {
          constructor() {
            this.eventType = 'ONACCESSGRANTED';
          }
          onEvent(payload) {
            console.log('Access granted to the custom camera:', payload);
            console.log('Custom camera is now active.');
          }
        }

        // Attach the event spy
        cameraComponent.spyOnEvent(new AccessGrantedSpy());

        // Start the camera node
        await node.start();
        console.log('Custom camera node started.');
      } catch (error) {
        console.error('Error enabling custom camera:', error);
      }
    }
  </script>
</body>
</html>
